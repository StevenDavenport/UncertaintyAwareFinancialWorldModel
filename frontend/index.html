<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Uncertainty-Aware Financial World Model</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="bg-orb bg-orb-a"></div>
  <div class="bg-orb bg-orb-b"></div>

  <header class="hero fade-in">
    <p class="eyebrow">Built on DreamerV3</p>
    <h1>Uncertainty-Aware Financial World Model</h1>
    <p class="sub">
      Interactive gate lab for precision/coverage tradeoffs. Tune thresholds and target settings live.
    </p>
  </header>

  <nav class="topnav fade-in">
    <button id="tabDashboardBtn" class="tab-btn is-active" type="button">Dashboard</button>
    <button id="tabRunnerBtn" class="tab-btn" type="button">Experiment Runner</button>
  </nav>

  <main id="tabDashboard" class="layout tab-pane is-active">
    <section class="panel controls stagger">
      <h2>Data</h2>
      <div class="group">
        <button id="loadDefaultBtn" class="btn">Load `frontend/data/bundle.json`</button>
        <label class="file-btn">
          Upload Bundle/CSV
          <input id="fileInput" type="file" accept=".json,.csv">
        </label>
      </div>
      <label class="field">
        <span>Run</span>
        <select id="runSelect"></select>
      </label>
      <label class="field">
        <span>Ticker</span>
        <select id="assetSelect"></select>
      </label>
      <div class="group">
        <label class="field compact">
          <span>Bars to Load</span>
          <input id="candleLimit" type="number" value="4000" min="200" step="100">
        </label>
        <button id="reloadCandlesBtn" class="btn btn-ghost">Reload Candles</button>
      </div>
      <div class="group">
        <label class="toggle"><input id="showSignalsChk" type="checkbox" checked> Show Gate Signals</label>
        <label class="toggle"><input id="showTradesChk" type="checkbox" checked> Show Executed Trades</label>
      </div>
      <p id="runMeta" class="meta">No run loaded.</p>
      <p id="chartStatus" class="meta">Chart: waiting for data.</p>

      <h2>Gate Controls</h2>
      <label class="field">
        <span>Confidence Floor <code>(`p_min` = <span id="pMinVal">0.50</span>)</code></span>
        <input id="pMin" type="range" min="0" max="1" step="0.005" value="0.5">
      </label>
      <label class="field">
        <span>Disagreement Ceiling <code>(`disagree_max` = <span id="disagreeVal">0.12</span>)</code></span>
        <input id="disagreeMax" type="range" min="0" max="0.5" step="0.001" value="0.12">
      </label>
      <label class="field">
        <span>Variance Ceiling <code>(`var_max` = <span id="varVal">0.40</span>)</code></span>
        <input id="varMax" type="range" min="0" max="1.0" step="0.002" value="0.4">
      </label>

      <h2>Target Controls</h2>
      <label class="field">
        <span>Return Hurdle <code>(`epsilon`)</code></span>
        <input id="epsilon" type="number" step="0.0001" value="0.0005">
      </label>
      <label class="field">
        <span>Execution Buffer <code>(`cost_buffer`)</code></span>
        <input id="costBuffer" type="number" step="0.0001" value="0.0002">
      </label>
      <label class="field">
        <span>Calibration Bins <code>(`reliability bins` = <span id="binsVal">10</span>)</code></span>
        <input id="bins" type="range" min="5" max="30" step="1" value="10">
      </label>

      <div class="group">
        <button id="resetBtn" class="btn btn-ghost">Reset to Run Defaults</button>
      </div>
    </section>

    <section class="panel results stagger">
      <h2>Live Metrics</h2>
      <div class="cards">
        <article class="card"><h3>Precision</h3><p id="precision">-</p></article>
        <article class="card"><h3>Coverage</h3><p id="coverage">-</p></article>
        <article class="card"><h3>Recall</h3><p id="recall">-</p></article>
        <article class="card"><h3>False Green</h3><p id="falseGreen">-</p></article>
        <article class="card"><h3>Greens</h3><p id="greens">-</p></article>
        <article class="card"><h3>Rows</h3><p id="count">-</p></article>
        <article class="card"><h3>Portfolio Return</h3><p id="pfReturn">-</p></article>
        <article class="card"><h3>Portfolio MDD</h3><p id="pfMdd">-</p></article>
        <article class="card"><h3>Executed Trades</h3><p id="pfTrades">-</p></article>
      </div>

      <div class="chart-grid">
        <article class="chart-card chart-wide">
          <h3>Candles + Signals + Executed Trades</h3>
          <div id="candlestickChart" class="tv-chart"></div>
          <p class="meta">Mouse wheel zoom, drag to pan. Signal arrows are based on current gate sliders.</p>
        </article>
        <article class="chart-card">
          <h3>Reliability Curve</h3>
          <canvas id="reliabilityChart" width="760" height="460"></canvas>
        </article>
        <article class="chart-card">
          <h3>Uncertainty Map (`p_mean` vs `disagree`)</h3>
          <canvas id="scatterChart" width="1560" height="460"></canvas>
        </article>
        <article class="chart-card chart-wide">
          <h3>Trade Ledger (Selected Ticker)</h3>
          <div class="table-wrap">
            <table class="trade-table">
              <thead>
                <tr>
                  <th>Entry</th>
                  <th>Exit</th>
                  <th>Dir</th>
                  <th>Bars</th>
                  <th>Notional</th>
                  <th>Net Return</th>
                  <th>PnL</th>
                </tr>
              </thead>
              <tbody id="tradeTableBody"></tbody>
            </table>
          </div>
        </article>
      </div>
    </section>
  </main>

  <main id="tabRunner" class="layout-runner tab-pane">
    <section class="panel controls stagger">
      <h2>Experiment Runner</h2>
      <p class="meta" id="apiStatus">API: checking...</p>

      <details class="runner-section" open>
        <summary>Run Eval</summary>
        <label class="field">
          <span>Model Logdirs (one per line)</span>
          <textarea id="evalLogdirs" rows="3">~/logdir/finwm/universe_tiny/seed_0
~/logdir/finwm/universe_tiny/seed_1
~/logdir/finwm/universe_tiny/seed_2
~/logdir/finwm/universe_tiny/seed_3
~/logdir/finwm/universe_tiny/seed_4</textarea>
        </label>
        <label class="field"><span>Dataset Dir</span><input id="evalDatasetDir" value="data/market/universe_5m"></label>
        <label class="field"><span>Split</span><select id="evalSplit"><option>test</option><option>val</option><option>train</option></select></label>
        <label class="field"><span>Forecast Horizon (bars)</span><input id="evalHorizon" type="number" value="12"></label>
        <label class="field"><span>MC Samples</span><input id="evalSamples" type="number" value="8"></label>
        <label class="field"><span>Return Hurdle (`epsilon`)</span><input id="evalEpsilon" type="number" step="0.0001" value="0.0005"></label>
        <label class="field"><span>Execution Buffer (`cost_buffer`)</span><input id="evalCostBuffer" type="number" step="0.0001" value="0.0002"></label>
        <label class="field"><span>Confidence Floor (`p_min`)</span><input id="evalPMin" type="number" step="0.001" value="0.50"></label>
        <label class="field"><span>Disagreement Ceiling (`disagree_max`)</span><input id="evalDisagreeMax" type="number" step="0.001" value="0.12"></label>
        <label class="field"><span>Variance Ceiling (`var_max`)</span><input id="evalVarMax" type="number" step="0.001" value="0.40"></label>
        <label class="field">
          <span>Signal Mode</span>
          <select id="evalSignalMode">
            <option value="directional">Directional (Long + Short)</option>
            <option value="long_only">Long Only</option>
          </select>
        </label>
        <label class="field"><span>Stop Multiplier (`stop_mult`)</span><input id="evalStopMult" type="number" step="0.1" value="2.0"></label>
        <label class="field"><span>Minimum Stop (`min_stop`)</span><input id="evalMinStop" type="number" step="0.0001" value="0.0005"></label>
        <label class="field"><span>Trade Cost Override (`trade_cost`, -1 = use cost buffer)</span><input id="evalTradeCost" type="number" step="0.0001" value="-1"></label>
        <label class="field"><span>Initial Capital (`bt_initial_capital`)</span><input id="evalBtInitialCapital" type="number" step="0.1" value="1.0"></label>
        <label class="field"><span>Risk Fraction (`bt_risk_fraction`)</span><input id="evalBtRiskFraction" type="number" step="0.001" value="0.01"></label>
        <label class="field"><span>Max Positions (`bt_max_positions`)</span><input id="evalBtMaxPositions" type="number" value="20"></label>
        <label class="field"><span>Max Gross Leverage (`bt_max_gross_leverage`)</span><input id="evalBtMaxGrossLeverage" type="number" step="0.1" value="3.0"></label>
        <label class="field">
          <span>One Position Per Asset (`bt_one_position_per_asset`)</span>
          <select id="evalBtOnePositionPerAsset">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </label>
        <label class="field"><span>Max Episodes (0 = all)</span><input id="evalMaxEpisodes" type="number" value="30"></label>
        <label class="field"><span>Output Directory</span><input id="evalOutdir" value="~/logdir/finwm/universe_tiny/eval_frontend_run"></label>
        <div class="group"><button id="runEvalBtn" class="btn">Start Eval</button></div>
      </details>

      <details class="runner-section">
        <summary>Run Sweep</summary>
        <label class="field"><span>Predictions CSV</span><input id="sweepPredCsv" value="~/logdir/finwm/universe_tiny/eval_frontend_run/predictions.csv"></label>
        <label class="field"><span>Output Directory</span><input id="sweepOutdir" value="~/logdir/finwm/universe_tiny/eval_frontend_run/sweep"></label>
        <label class="field"><span>Confidence Grid (`p_values`)</span><input id="sweepPValues" value="0.35,0.40,0.45,0.50,0.55,0.60,0.65"></label>
        <label class="field"><span>Disagreement Grid (`disagree_values`)</span><input id="sweepDisagreeValues" value="0.04,0.06,0.08,0.10,0.12,0.15,0.20"></label>
        <label class="field"><span>Variance Grid (`var_values`)</span><input id="sweepVarValues" value="0.10,0.15,0.20,0.25,0.30,0.40,0.60"></label>
        <label class="field"><span>Min Coverage</span><input id="sweepMinCoverage" type="number" step="0.001" value="0.01"></label>
        <label class="field"><span>Top-K Results</span><input id="sweepTopk" type="number" value="40"></label>
        <div class="group"><button id="runSweepBtn" class="btn">Start Sweep</button></div>
      </details>

      <details class="runner-section">
        <summary>Build Frontend Bundle</summary>
        <label class="field">
          <span>Eval Dirs (one per line, supports `label=path`)</span>
          <textarea id="bundleEvalDirs" rows="3">h12_quick3=~/logdir/finwm/universe_tiny/eval_h12_test_quick30
h12_quick5=~/logdir/finwm/universe_tiny/eval_h12_test_quick30_5seed</textarea>
        </label>
        <label class="field"><span>Output JSON</span><input id="bundleOutJson" value="frontend/data/bundle.json"></label>
        <label class="field"><span>Max Rows per Run (0 = all)</span><input id="bundleMaxRows" type="number" value="0"></label>
        <div class="group"><button id="runBundleBtn" class="btn">Build Bundle</button></div>
      </details>

      <details class="runner-section">
        <summary>Run Train Ensemble</summary>
        <label class="field"><span>Configs (space-separated)</span><input id="trainConfigs" value="market_tiny"></label>
        <label class="field"><span>Seeds (comma-separated)</span><input id="trainSeeds" value="0,1,2"></label>
        <label class="field"><span>Logroot</span><input id="trainLogroot" value="~/logdir/finwm/universe_tiny_frontend"></label>
        <label class="field"><span>Dataset Dir</span><input id="trainDatasetDir" value="data/market/universe_5m"></label>
        <label class="field"><span>JAX Platform</span><input id="trainJaxPlatform" value="cpu"></label>
        <label class="field"><span>JAX Prealloc</span><input id="trainJaxPrealloc" value="False"></label>
        <div class="group"><button id="runTrainBtn" class="btn">Start Train</button></div>
      </details>

      <h3 class="runner-title">Run Monitor</h3>
      <div class="group">
        <button id="refreshRunsBtn" class="btn btn-ghost">Refresh Runs</button>
      </div>
      <label class="field"><span>Select Run</span><select id="runsSelect"></select></label>
      <label class="field"><span>Stop Selected Run</span><button id="stopRunBtn" class="btn btn-ghost">Stop Run</button></label>
      <pre id="runLogTail" class="log-tail"></pre>
    </section>
  </main>

  <footer class="foot fade-in">
    <p>Use this page for experimentation. For leak-free benchmarking: tune on validation, report once on locked test.</p>
  </footer>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="./app.js"></script>
</body>
</html>
